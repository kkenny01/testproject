
<!-- saved from url=(0061)https://dl.dropboxusercontent.com/u/32777026/post2google2.htm -->
<html class="ui-mobile"><head><meta http-equiv="Content-Type" content="text/html;"><!--<base href="https://dl.dropboxusercontent.com/u/32777026/post2google2.htm">--><base href=".">
    
    <meta name="viewport" content="width=device-width, initial-scale=1"> 
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.2/jquery.mobile.min.css">
    <link rel="stylesheet" href="https://dl.dropboxusercontent.com/u/32777026/table.css">
    <style type="text/css">
    <!--
        html { background-color: #333; }
        @media only screen and (min-width: 600px){
            .ui-page {
                width: 600px !important;
                margin: 0 auto !important;
                position: relative !important;
                border-right: 5px #666 outset !important;
                border-left: 5px #666 outset !important;
            }
        }
    -->
    </style>
    <script src="cordova.js"></script>
	<script src="./BLE_files/jquery.min.js"></script>
    <script src="./BLE_files/jquery.mobile.min.js"></script>
	<title>BLE Search System Demo</title></head><body class="ui-mobile-viewport ui-overlay-a">

	<div data-role="page" data-url="/u/32777026/post2google2.htm" tabindex="0" class="ui-page ui-page-theme-a ui-page-active" style="min-height: 681px;">

	<div data-role="header" role="banner" class="ui-header ui-bar-inherit">
		<h1 class="ui-title" role="heading" aria-level="1">BLE Search System Demo</h1>
	</div><!-- /header -->

	<div data-role="content" class="ui-content" role="main">	

		<form id="fm" name="fm" action="" method="post">
		<p>
		Action (if you like):<br>
		<div class="ui-select">
		  <div id="action-button" class="ui-btn ui-icon-carat-d ui-btn-icon-right ui-corner-all ui-shadow"><span>Action</span><select id="action" name="action">
		  <option value="--">Please select</option>
		  <option value="newUser">New User</option>
		  <option value="login" selected="">Login</option>
		  <option value="logout">Logout</option>
		  <option value="alive">Alive</option>
		  <option value="setProfile">Set Profile</option>
		  <option value="getProfile">Get Profile</option>
		  <option value="changePassword">New Password</option>
		  <option value="forgetPassword">Forget Password</option>
		  <option value="setElder">Set Elder</option>
		  <option value="getElder">Get Elder</option>
		  <option value="openSearch">Open for Search</option>
		  <option value="closeSearch">Close for Search</option>
		  <option value="setBLE">Set BLE</option>
		  <option value="getBLE">Get BLE</option>
		  <option value="getOpenBLE">Get Open BLE</option>
		  <option value="findBLE">Find a BLE</option>
		</select></div></div><br>
		<div class="ui-select"><div id="select-18-button" class="ui-btn ui-icon-carat-d ui-btn-icon-right ui-corner-all ui-shadow"><select name="lang">
		  <option value="tw">Traditional Chinese</option> 
		  <option value="en">English</option>   
		</select></div></div><br>
		Please specify relative fields:<br>
		</p>
		<div class="toggle" id="vendor" style="display: none;">  Vendor(Please contact me to get key):      <div class="ui-input-text ui-body-inherit ui-corner-all ui-shadow-inset"><input id="vendori" type="text" name="vendor"></div><br></div>
		<div class="toggle" id="user" style="display: block;">    User:        <div class="ui-input-text ui-body-inherit ui-corner-all ui-shadow-inset"><input id="useri" type="text" name="user"></div><br></div>
		<div class="toggle" id="pwd" style="display: block;">     Password:    <div class="ui-input-text ui-body-inherit ui-corner-all ui-shadow-inset"><input id="pwdi" type="password" name="pwd"></div><br></div>
		<div class="toggle" id="oldPwd" style="display: none;">  Old Password:<div class="ui-input-text ui-body-inherit ui-corner-all ui-shadow-inset"><input id="oldPwdi" type="password" name="oldPwd"></div><br></div>
		<div class="toggle" id="key" style="display: none;">     Key:         <div class="ui-input-text ui-body-inherit ui-corner-all ui-shadow-inset"><input id="keyi" type="text" name="key"></div><br></div>
		<div class="toggle" id="name" style="display: none;">    Name:        <div class="ui-input-text ui-body-inherit ui-corner-all ui-shadow-inset"><input id="namei" type="text" name="name"></div><br></div>
		<div class="toggle" id="phone" style="display: none;">   Phone#:      <div class="ui-input-text ui-body-inherit ui-corner-all ui-shadow-inset"><input id="phonei" type="text" name="phone"></div><br></div>
		<div class="toggle" id="comail" style="display: none;">  Second mail: <div class="ui-input-text ui-body-inherit ui-corner-all ui-shadow-inset"><input id="comaili" type="text" name="comail"></div><br></div>
		<div class="toggle" id="gender" style="display: none;">  Gender:      <div class="ui-input-text ui-body-inherit ui-corner-all ui-shadow-inset"><input id="genderi" type="text" name="gender"></div><br></div>
		<div class="toggle" id="des" style="display: none;">     Descript:    <div class="ui-input-text ui-body-inherit ui-corner-all ui-shadow-inset"><input id="desi" type="text" name="des"></div><br></div>
		<div class="toggle" id="album" style="display: none;">   Album:       <div class="ui-input-text ui-body-inherit ui-corner-all ui-shadow-inset"><input id="albumi" type="text" name="album"></div><br></div>
		<div class="toggle" id="address" style="display: none;"> Address:     <div class="ui-input-text ui-body-inherit ui-corner-all ui-shadow-inset"><input id="addressi" type="text" name="address"></div><br></div>
		<div class="toggle" id="pin" style="display: none;">     PIN code:    <div class="ui-input-text ui-body-inherit ui-corner-all ui-shadow-inset"><input id="pini" type="text" name="pin"></div><br></div>
		<div class="toggle" id="loc" style="display: none;">     Location:    <div class="ui-input-text ui-body-inherit ui-corner-all ui-shadow-inset"><input id="loci" type="text" name="location"></div><br></div>
		<p></p>
		</form>
		<div class="toggle" id="sub" style="display: block;"><button id="submit" value="NONE" class=" ui-btn ui-shadow ui-corner-all">Send</button></div>
		<div class="toggle" id="msg" style="display: none;"></div>
		<button id="scan">SCAN</button>	
	</div><!-- /content -->

</div><!-- /page -->

<script>
$(function () {
  var res={"login":{"op":["user","pwd"],"sub":function(r) {
			 if (r.key) {$("#keyi").val(r.key); $("#msg").text("OK").show();} else $("#msg").text(r.Error).show();} },
		   "logout":{"op":[],"sub":function(r) {$("#msg").text(r.Message||r.Error).show();}},
		   "newUser":{"op":["vendor","user"],"sub":function(r) {$("#msg").text(r.Message||r.Error).show();}},
		   "alive":{"op":[],"sub":function(r) {$("#msg").text(r.User||r.Error).show();}},
		   "setProfile":{"op":["name","phone","comail"],"sub":function(r) {$("#msg").text(r.Message||r.Error).show();}},
		   "getProfile":{"op":[],"sub":function(r) {
		     if (r.Name!==undefined) {
			   $("#namei").val(r.Name);$("#name").show(); 
			   $("#phonei").val(r.Phone);$("#phone").show();
			   $("#comaili").val(r.Comail);$("#comail").show();
			   } 
			 else $("#msg").text(r.Error).show(); }},
		   "changePassword":{"op":["pwd","oldPwd"],"sub":function(r) {$("#msg").text(r.Message||r.Error).show();}},		   
		   "forgetPassword":{"op":["user"],"sub":function(r) {$("#msg").text(r.Message||r.Error).show();}},
		   "setElder":{"op":["name","gender","des","album"],"sub":function(r) {$("#msg").text(r.Message||r.Error).show();}},
		   "getElder":{"op":["name"],"sub":function(r) {
		     if (r.Elder!==undefined) 
			   if (r.Elder.length == 1) {
			     $("#genderi").val(r.Elder[0].Gender);$("#gender").show(); 
			     $("#desi").val(r.Elder[0].Describe);$("#des").show();
			     $("#albumi").val(r.Elder[0].Album);$("#album").show();
			     } 
			   else $("#msg").html(jTable(r.Elder, "Elder")).show();
			 else $("#msg").text(r.Error).show(); }},
		   "openSearch":{"op":["name","address"],"sub":function(r) {$("#msg").text(r.Message||r.Error).show();}},
		   "closeSearch":{"op":["name"],"sub":function(r) {$("#msg").text(r.Message||r.Error).show();}},
		   "setBLE":{"op":["name","address","pin"],"sub":function(r) {$("#msg").text(r.Message||r.Error).show();}},
		   "getBLE":{"op":["address"],"sub":function(r) {
		     if (r.BLE!==undefined) 
			   if (r.BLE.length == 1) {		     
			     $("#namei").val(r.BLE[0].Name);$("#name").show(); 
			     $("#pini").val(r.BLE[0].PIN);$("#pin").show();
			     }
			   else $("#msg").html(jTable(r.BLE, "BLE", true)).show();
			 else $("#msg").text(r.Error).show(); }},
		   "getOpenBLE":{"op":[],"sub":function(r) {
		     if (r.BLE !== undefined) $("#msg").html(jTable(r.BLE, "BLE")).show();
		     else $("#msg").text(r.Error).show();}},
		   "findBLE":{"op":["address", "loc"],"sub":function(r) {$("#msg").text(r.Message||r.Error).show();}}
		  };
		  
  $("#submit").click(function(){ 
 	$("div.toggle").hide();
	var v = $( "#action option:selected" ).val() ;
    $.ajax({
         type: 'POST',
         url: "https://script.google.com/macros/s/AKfycbxpWcV6dClI-gY_RExPYO5q_y74QMNAW9CkAl9wjx89asP7cget/exec",
         data: $('#fm').serialize(), 
         success: function(response) {
            alert(JSON.stringify(response));  //*******************Remove this line when ready
			if (res[v] && res[v].sub) {
			  res[v].sub(response);
			}
         },
        error: function(response, status, error) {
            alert(error+":"+JSON.stringify(status)+":"+JSON.stringify(response));
        }
     });	
    $("#action").val("--");	 
  });
  
  $("#scan").click(function() {
     start_scan(); 
  });
  
  $("#action").change(function() {
    var v = $( "#action option:selected" ).val() ;
	$("div.toggle").hide();
	if (res[v]) {
	  for (var x in res[v].op) {
	    $("div#"+res[v].op[x]).show();
	  }
	  $("div#sub").show();
	}
  });
  $("#action").change();  
});

// Convert a json object array *obj* into jqm table format with table name *tname and option *col_head* is true for first column is the head also
function jTable(obj, tname, col_head) {
	if (!$.isArray(obj) || obj.length < 1) return "";
	var str1 = '<table data-role="table" id="'+(tname || 'JQMTable')+'" data-mode="reflow"> <thead> <tr>';
	var str2 = '</tr> </thead> <tbody>';
	var str3 = '</tbody> </table>';
	var strx = "";
	var header = [];
	for (var r in obj[0]) {
	  str1 += " <th>"+r+"</th>";
	  header.push(r);
	}
	for (var i = 0; i < obj.length; i++) {
	    strx += '<tr id="'+(tname || 'JQMTable')+'_'+i+'"> ';
		var j = 0;
		if (col_head) {
		strx += " <th>"+obj[i][header[0]]+"</th>";
		j = 1;
		}
	    for ( ; j < header.length; j++)
		    strx += " <td>"+obj[i][header[j]]+"</td>";
	}	
	return str1+str2+strx+str3;   
}

// Text output.
var gTestLogData = '';

// Keeps track of devices found during scan.
// Used to test a device only once per scan.
var gFoundDevices = {};

// Tree structure with all devices, services,
// characteristics and descriptors.
var gDeviceData = {};

// Tracees async calls when building device tree.
var gCallTracer = 0;

// Number of failed tests.
var gFailedTests = 0;

function testLog(message) {
	gTestLogData += message + '\n';
	$("#msg").text(gTestLogData).show();
}

function closeAllDevices()
{
	for (var handle in gDeviceData){
		
		evothings.ble.close(handle);
	}
}

function displayDeviceData()
{
	displayDeviceTree(gDeviceData, 1, '');
}

function displayDeviceTree(obj, level, indent)
{
	var label = 'Unknown: ';
	(level == 1) && (label = 'Device: ');
	(level == 2) && (label = 'Service: ');
	(level == 3) && (label = 'Characteristic: ');
	(level == 4) && (label = 'Descriptor: ');

	// Display top-level properties (nicer if these are shown first).
	for (var prop in obj)	{
		if (obj.hasOwnProperty(prop))	{
			var value = obj[prop]
			if (typeof value != 'object') {
				testLog(indent + prop + ': ' + value)
			}
		}
	}

	// Display object properties (children).
	for (prop in obj)	{
		if (obj.hasOwnProperty(prop))	{
			value = obj[prop]
			if (typeof value == 'object')
			{
				testLog(indent + label)
				displayDeviceTree(value, level + 1, indent + '  ')
			}
		}
	}
}

function incrementCallTracer()
{
	++gCallTracer;
}

function decrementCallTracer()
{
	--gCallTracer;
	if (0 === gCallTracer)
	{
		displayDeviceData();
		closeAllDevices();

		gFailedTests && testLog('FAIL: Number of fails: ' + gFailedTests);
		!gFailedTests && testLog('PASS: All tests passed');
		testLog('DONE: Test finished');
	}
}

function start_scan() {
	stopScan();

	gTestLogData = '';
	gFoundDevices = {};
	gDeviceData = {};
	gCallTracer = 0;
	gFailedTests = 0;

	testLog('Starting test');

	// Scan and start first test.
	if (evothings === undefined) testLog("Plugin not found");
	else testScan();
}

function stopScan() {
	evothings.ble.stopScan();
}

function testScan() {
	testLog('Scanning...');

	evothings.ble.startScan(
		function(device)	{
			// Run the test suite once per device.
			if (!gFoundDevices[device.address])		{
				// Mark device as found.
				gFoundDevices[device.address] = true;

				// Start first test.
				testConnectClose(device.address, 0);
			}
		},
		function(errorCode)	{
			testLog('FAIL: startScan error: ' + errorCode);
		}
	);
}

// Connect and close 10 times.
function testConnectClose(address, counter) {
	evothings.ble.connect(
		address,
		function(info)	{
			testLog(JSON.stringify(info));
			if (info.state == 2) {// Connected
				testLog('LOG:  testConnectClose(' + counter + ') device: ' + address);

				if (counter < 10)	{
					evothings.ble.close(info.deviceHandle);
				}
				else	{
					testLog('PASS: testConnectClose device: ' + address);

					// This can be moved to a later test or to last test,
					// depending on whether the test suite should pick up
					// new devices.
					stopScan();

					// Run next test.
					// Create entry for device.
					gDeviceData[info.deviceHandle] = {};
					gDeviceData[info.deviceHandle]['Address'] = address;
					gDeviceData[info.deviceHandle]['ConnectCloseTest'] = 'PASS';
					testRSSI(info.deviceHandle, gDeviceData[info.deviceHandle], 0);
				}
			}
			else if (info.state === 0) 	{ // Disconnected
				if (counter < 10)	{
					// Connect again.
					testConnectClose(address, counter + 1);

					// If a timeout is needed, use this code:
					// setTimeout(function() { testConnectClose(address, counter + 1); }, 1000);
				}
			}
		},
		function(errorCode)		{
			testLog('FAIL: testConnectClose device: ' + address + ' error: ' + errorCode);
			testLog('Try to start test again (this works on iOS)');
		}
	);
}

function testRSSI(deviceHandle, deviceData, counter) {
	// Useful for skipping the RSSI test which takes time.
	//testServices(deviceHandle, deviceData); return;

	evothings.ble.rssi(
		deviceHandle,
		function(rssi)	{
			testLog('LOG:  testRSSI(' + counter + ') deviceHandle: ' + deviceHandle +
				' rssi: ' + rssi);

			if (counter < 10)	{
				// Read RSSI again. Delay must be used, BLE cannot
				// handle rapid RSSI polling (at least on iOS).
				setTimeout(function(){testRSSI(deviceHandle, deviceData, counter + 1);}, 1000);
			}
			else	{
				testLog('PASS: testRSSI device: ' + deviceHandle);

				deviceData['RSSITest'] = 'PASS';

				// Run next test.
				testServices(deviceHandle, deviceData);
			}

		},
		function(errorCode)	{
			testLog('[FAIL testRSSI] error: ' + errorCode);
		});
}

function testServices(deviceHandle, deviceData) {
	testLog('Device ' + deviceHandle + ': Reading all services,');
	testLog('characteristics and desciptors, please wait...');

	incrementCallTracer();

	evothings.ble.services(
		deviceHandle,
		function(services)	{
			for (var i = 0; i < services.length; ++i)	{
				var service = services[i];

				// Create entry for service.
				deviceData[service.handle] = {};
				deviceData[service.handle]['UUID'] = service.uuid;

				// Test test.
				testCharacteristics(deviceHandle, service.handle, deviceData[service.handle]);
			}

			decrementCallTracer();
		},
		function(errorCode)	{
			testLog('FAIL: testServices device: ' + deviceHandle + ' error: ' + errorCode);
			++gFailedTests;
			decrementCallTracer();
		});
}

function testCharacteristics(deviceHandle, serviceHandle, serviceData){
	incrementCallTracer();

	evothings.ble.characteristics(
		deviceHandle,
		serviceHandle,
		function(characteristics)	{
			//testLog('found characteristics: ' + characteristics.length);
			for (var i = 0; i < characteristics.length; ++i)	{
				var characteristic = characteristics[i];

				// Create entry for characteristic.
				serviceData[characteristic.handle] = {};
				serviceData[characteristic.handle]['UUID'] = characteristic.uuid;

				//testLog('characteristic uuid: ' + characteristic.uuid);

				var readAllowed = characteristic.permissions & 1; // PERMISSION_READ
				testReadCharacteristic(
					deviceHandle,
					characteristic.handle,
					serviceData[characteristic.handle],
					readAllowed);

				// Next test.
				testDescriptors(
					deviceHandle,
					characteristic.handle,
					serviceData[characteristic.handle]);
			}

			decrementCallTracer();
		},
		function(errorCode)		{
			testLog('FAIL: testCharacteristics: ' + errorCode);
			serviceData['TestCharacteristics'] = 'FAIL: ' + errorCode;
			++gFailedTests;
			decrementCallTracer();
		}
	);
}

function testReadCharacteristic(deviceHandle, characteristicHandle, characteristicData, readAllowed) {
	incrementCallTracer();

	evothings.ble.readCharacteristic(
		deviceHandle,
		characteristicHandle,
		function(data)	{
			characteristicData['Data'] = escape(
				String.fromCharCode.apply(
					null,
					new Uint8Array(data)));
			decrementCallTracer();
		},
		function(errorCode)	{
			if (readAllowed)	{
				characteristicData['Data'] = errorCode;
				++gFailedTests;
			}
			else	{
				characteristicData['Data'] = 'EXPECTED: ' + errorCode;
			}

			decrementCallTracer();
		}
	);
}

function testDescriptors(deviceHandle, characteristicHandle, characteristicData){
	incrementCallTracer();

	evothings.ble.descriptors(
		deviceHandle,
		characteristicHandle,
		function(descriptors)	{
			for (var i = 0; i < descriptors.length; ++i)	{
				var descriptor = descriptors[i];

				// Create entry for descriptor.
				characteristicData[descriptor.handle] = {};
				characteristicData[descriptor.handle]['UUID'] = descriptor.uuid;

				var readAllowed = descriptor.permissions & 1; // PERMISSION_READ
				testReadDescriptor(
					deviceHandle,
					descriptor.handle,
					characteristicData[descriptor.handle],
					readAllowed);
			}

			decrementCallTracer();
		},
		function(errorCode)	{
			testLog('FAIL: testDescriptors: ' + errorCode + ' (see details below)');
			characteristicData['TestDescriptors'] = 'FAIL: ' + errorCode;
			++gFailedTests;
			decrementCallTracer();
		}
	);
}

function testReadDescriptor(deviceHandle, descriptorHandle, descriptorData, readAllowed){
	incrementCallTracer();

	evothings.ble.readDescriptor(
		deviceHandle,
		descriptorHandle,
		function(data)		{
			descriptorData['Data'] = escape(
				String.fromCharCode.apply(
					null,
					new Uint8Array(data)));
			decrementCallTracer();
		},
		function(errorCode)		{
			if (readAllowed)			{
				descriptorData['Data'] = errorCode;
				++gFailedTests;
			}
			else			{
				descriptorData['Data'] = 'EXPECTED: ' + errorCode;
			}

			decrementCallTracer();
		}
	);
}

</script>
<div class="ui-loader ui-corner-all ui-body-a ui-loader-default"><span class="ui-icon-loading"></span><h1>loading</h1></div></body></html>